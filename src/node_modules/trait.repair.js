var sort = require('sort')
var filters = require('filters')

/**
 * Repair Trait
 * Repair anything that's up for repair, prioritize
 * - ...
 *
 * TODO: prioritize structures
 * TODO: remember current repair target (keep repairing)
 *
 * @param {Creep} creep
 * @returns {boolean} whether a task was assigned or not
 */
module.exports = (creep) => {
  // Identify structures that require repair.
  var repairTargets = creep.room.find(FIND_STRUCTURES, {
    filter: structure => filters.needsRepair(structure) && filters.sameRoom(creep, structure)
  })

  // When nothing requires repair skip repair trait.
  if (repairTargets.length === 0) {
    return false
  }

  // Prioritize sort repair target.
  repairTargets.sort(sort.structuresByHits)

  // Choose a target.
  var target = repairTargets[0]

  // Try to repair.
  switch (creep.repair(target)) {
    // When not in range try to move closer.
    case ERR_NOT_IN_RANGE:
      var moveStatus = creep.moveTo(target)
      return (moveStatus === OK) || (moveStatus = ERR_TIRED)
    // Creep is harvesting.
    case OK:
      return true
    // Something other error, so we didn't assign a task after all.
    default:
      return false
  }
}
